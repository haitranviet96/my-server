name: NixOS System Rebuild

run-name: ${{ github.actor }} is rebuilding NixOS system ğŸ”§

on:
  push:
    branches:
      - main
    paths:
      - infra/flake.nix
      - infra/disko.nix
      - .github/workflows/nixos-rebuild.yml
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even without flake changes'
        required: false
        default: false
        type: boolean
      rollback:
        description: 'Rollback to previous generation'
        required: false
        default: false
        type: boolean

jobs:
  nixos-rebuild:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config <<EOF
          Host haivita.top
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: Validate flake configuration
        run: |
          current_gen=$(ssh ${{ secrets.SSH_USERNAME }}@haivita.top "sudo nixos-rebuild list-generations | head -1 | awk '{print \$1}'")
          echo "current_generation=$current_gen" >> $GITHUB_OUTPUT
          echo "Current generation: $current_gen"
        id: current_gen

      - name: Rollback to previous generation
        if: ${{ inputs.rollback == true }}
        run: |
          echo "ğŸ”„ Rolling back to previous generation..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "sudo nixos-rebuild switch --rollback"
          echo "âœ… Rollback completed"
          exit 0

      - name: Validate flake.nix syntax
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ” Validating flake.nix syntax..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "nix flake check --no-build github:haitranviet96/my-server/${{ github.sha }}#nixosConfigurations.myserver"

      - name: Show flake info
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ“‹ Showing flake configuration..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "nix flake show github:haitranviet96/my-server/${{ github.sha }}"

      - name: Build NixOS configuration (dry-run)
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ§ª Performing dry-run build..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "nixos-rebuild dry-build --flake github:haitranviet96/my-server/${{ github.sha }}#myserver"

      - name: Build NixOS configuration
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ”¨ Building NixOS configuration..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "nixos-rebuild build --flake github:haitranviet96/my-server/${{ github.sha }}#myserver"

      - name: Test configuration before switch
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ§ª Testing new configuration..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "sudo nixos-rebuild test --flake github:haitranviet96/my-server/${{ github.sha }}#myserver"

      - name: Switch to new configuration
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ”„ Switching to new configuration..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "sudo nixos-rebuild switch --flake github:haitranviet96/my-server/${{ github.sha }}#myserver"

      - name: Verify critical services are running
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ” Verifying critical services..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "
            systemctl is-active sshd &&
            systemctl is-active docker &&
            systemctl is-active tailscaled &&
            echo 'âœ… Critical services verification completed'
          "

      - name: Check system status
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ“Š System status after rebuild:"
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "
            systemctl --failed --no-pager
            echo ''
            echo 'Recent journal entries:'
            journalctl --no-pager --lines=20 --since='5 minutes ago'
            echo 'âœ… NixOS system rebuild completed successfully'
          "

      - name: Cleanup old generations
        if: ${{ inputs.rollback != true }}
        run: |
          echo "ğŸ§¹ Cleaning up old generations (keeping last 5)..."
          ssh ${{ secrets.SSH_USERNAME }}@haivita.top "
            sudo nix-collect-garbage --delete-older-than 14d
            echo ''
            echo 'Available generations:'
            sudo nixos-rebuild list-generations | head -10
          "

      - name: Create recovery instructions
        if: failure() && inputs.rollback != true
        run: |
          echo "ğŸš¨ Build failed! Recovery instructions:"
          echo ""
          echo "To rollback manually, SSH into the server and run:"
          echo "  sudo nixos-rebuild switch --rollback"
          echo ""
          echo "Or trigger rollback via GitHub Actions:"
          echo "  - Go to Actions tab"
          echo "  - Run 'NixOS System Rebuild' workflow"
          echo "  - Set 'rollback' input to 'true'"
          echo ""
          echo "Current generation that can be rolled back to: ${{ steps.current_gen.outputs.current_generation }}"