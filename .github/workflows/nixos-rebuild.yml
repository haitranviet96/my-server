name: NixOS System Rebuild

run-name: ${{ github.actor }} is rebuilding NixOS system ğŸ”§

on:
  push:
    branches:
      - main
    paths:
      - infra/flake.nix
      - infra/disko.nix
      - .github/workflows/nixos-rebuild.yml
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even without flake changes'
        required: false
        default: false
        type: boolean
      rollback:
        description: 'Rollback to previous generation'
        required: false
        default: false
        type: boolean

jobs:
  nixos-rebuild:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Setup NixOS environment
        shell: bash
        run: |
          ./.github/scripts/setup-nixos-env.sh

      - name: Store current generation info
        id: current_gen
        shell: bash
        run: |
          current_gen=$(sudo nixos-rebuild list-generations | head -1 | awk '{print $1}')
          echo "current_generation=$current_gen" >> $GITHUB_OUTPUT
          echo "Current generation: $current_gen"

      - name: Rollback to previous generation
        if: ${{ inputs.rollback == true }}
        shell: bash
        run: |
          echo "ğŸ”„ Rolling back to previous generation..."
          sudo nixos-rebuild switch --rollback
          echo "âœ… Rollback completed"
          exit 0

      - name: Validate flake.nix syntax
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ” Validating flake.nix syntax..."
          cd infra
          nix flake check --no-build

      - name: Show flake info
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ“‹ Showing flake configuration..."
          cd infra
          nix flake show

      - name: Build NixOS configuration (dry-run)
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ§ª Performing dry-run build..."
          cd infra
          nixos-rebuild dry-build --flake .#myserver

      - name: Build NixOS configuration
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ”¨ Building NixOS configuration..."
          cd infra
          nixos-rebuild build --flake .#myserver

      - name: Test configuration before switch
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ§ª Testing new configuration..."
          cd infra
          sudo nixos-rebuild test --flake .#myserver

      - name: Switch to new configuration
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ”„ Switching to new configuration..."
          cd infra
          sudo nixos-rebuild switch --flake .#myserver

      - name: Verify critical services are running
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ” Verifying critical services..."
          
          # Check SSH is still working (we're connected via it)
          systemctl is-active sshd
          
          # Check Docker is running
          systemctl is-active docker
          
          # Check Tailscale is running
          systemctl is-active tailscaled
          
          # Check if we can still reach the network
          ping -c 1 8.8.8.8 || echo "âš ï¸ Network connectivity issue detected"
          
          echo "âœ… Critical services verification completed"

      - name: Check system status
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ“Š System status after rebuild:"
          systemctl --failed --no-pager
          echo ""
          echo "Recent journal entries:"
          journalctl --no-pager --lines=20 --since="5 minutes ago"
          echo "âœ… NixOS system rebuild completed successfully"

      - name: Update flake lock file
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          cd infra
          nix flake update
          if git diff --exit-code flake.lock; then
            echo "ğŸ“Œ No flake.lock changes needed"
          else
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add flake.lock
            git commit -m "chore: update flake.lock after successful rebuild"
            git push || echo "âš ï¸ Could not push flake.lock update"
          fi

      - name: Cleanup old generations
        if: ${{ inputs.rollback != true }}
        shell: bash
        run: |
          echo "ğŸ§¹ Cleaning up old generations (keeping last 5)..."
          sudo nix-collect-garbage --delete-older-than 14d
          echo ""
          echo "Available generations:"
          sudo nixos-rebuild list-generations | head -10

      - name: Create recovery instructions
        if: failure() && inputs.rollback != true
        shell: bash
        run: |
          echo "ğŸš¨ Build failed! Recovery instructions:"
          echo ""
          echo "To rollback manually, run:"
          echo "  sudo nixos-rebuild switch --rollback"
          echo ""
          echo "Or trigger rollback via GitHub Actions:"
          echo "  - Go to Actions tab"
          echo "  - Run 'NixOS System Rebuild' workflow"
          echo "  - Set 'rollback' input to 'true'"
          echo ""
          echo "Current generation that can be rolled back to: ${{ steps.current_gen.outputs.current_generation }}"