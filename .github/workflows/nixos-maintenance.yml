name: NixOS Maintenance

run-name: ${{ github.actor }} is performing NixOS maintenance ðŸ”§

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Maintenance operation to perform'
        required: true
        type: choice
        options:
          - 'update-flake'
          - 'cleanup-generations'
          - 'rebuild-boot'
          - 'check-health'
          - 'optimize-store'
        default: 'check-health'
      keep_generations:
        description: 'Number of generations to keep (for cleanup)'
        required: false
        default: '5'
        type: string

jobs:
  maintenance:
    runs-on: self-hosted
    timeout-minutes: 45
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Setup NixOS environment
        shell: bash
        run: |
          ./.github/scripts/setup-nixos-env.sh

      - name: Update flake inputs
        if: ${{ inputs.operation == 'update-flake' }}
        shell: bash
        run: |
          echo "ðŸ”„ Updating flake inputs..."
          cd infra
          nix flake update
          
          echo "ðŸ“‹ Updated inputs:"
          git diff flake.lock
          
          if ! git diff --exit-code flake.lock; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add flake.lock
            git commit -m "chore: update flake inputs"
            git push
            echo "âœ… Flake inputs updated and committed"
          else
            echo "ðŸ“Œ No updates available"
          fi

      - name: Cleanup old generations
        if: ${{ inputs.operation == 'cleanup-generations' }}
        shell: bash
        run: |
          echo "ðŸ§¹ Cleaning up old NixOS generations..."
          echo "Current generations:"
          sudo nixos-rebuild list-generations
          echo ""
          
          # Keep specified number of generations
          sudo nix-env --delete-generations +${{ inputs.keep_generations }} --profile /nix/var/nix/profiles/system
          sudo nix-collect-garbage -d
          
          echo ""
          echo "Remaining generations:"
          sudo nixos-rebuild list-generations

      - name: Rebuild boot configuration
        if: ${{ inputs.operation == 'rebuild-boot' }}
        shell: bash
        run: |
          echo "ðŸ¥¾ Rebuilding boot configuration..."
          cd infra
          sudo nixos-rebuild boot --flake .#myserver
          echo "âœ… Boot configuration updated. Reboot required to activate."

      - name: System health check
        if: ${{ inputs.operation == 'check-health' }}
        shell: bash
        run: |
          echo "ðŸ¥ Performing system health check..."
          
          echo "=== System Information ==="
          uname -a
          echo ""
          
          echo "=== NixOS Version ==="
          nixos-version
          echo ""
          
          echo "=== Current Generation ==="
          sudo nixos-rebuild list-generations | head -3
          echo ""
          
          echo "=== Failed Services ==="
          systemctl --failed --no-pager || echo "No failed services"
          echo ""
          
          echo "=== Disk Usage ==="
          df -h /
          df -h /nix/store
          echo ""
          
          echo "=== Memory Usage ==="
          free -h
          echo ""
          
          echo "=== Docker Status ==="
          docker system df
          echo ""
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          
          echo "=== Network Status ==="
          tailscale status --peers=false 2>/dev/null || echo "Tailscale not connected"
          echo ""
          
          echo "=== Recent Critical Logs ==="
          journalctl --no-pager --priority=err --since="24 hours ago" || echo "No critical errors in last 24h"
          
          echo "âœ… Health check completed"

      - name: Optimize Nix store
        if: ${{ inputs.operation == 'optimize-store' }}
        shell: bash
        run: |
          echo "âš¡ Optimizing Nix store..."
          
          echo "Store size before optimization:"
          du -sh /nix/store
          
          sudo nix-store --gc
          sudo nix-store --optimize
          
          echo ""
          echo "Store size after optimization:"
          du -sh /nix/store
          
          echo "âœ… Store optimization completed"

      - name: Summary
        shell: bash
        run: |
          echo "ðŸ“Š Maintenance operation '${{ inputs.operation }}' completed successfully"
          echo ""
          echo "Current system state:"
          echo "- Generation: $(sudo nixos-rebuild list-generations | head -1)"
          echo "- Uptime: $(uptime)"
          echo "- Load: $(cat /proc/loadavg)"